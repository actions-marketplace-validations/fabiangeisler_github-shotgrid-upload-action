name: 'Upload to ShotGrid'
author: 'Fabian Geisler'
description: 'Upload an artifact to a ShotGrid entity field.'

branding:
  icon: upload-cloud
  color: blue

inputs:
  upload_file:
    description: 'Path to the file you want to upload. Glob patterns are supported, but
                  only the first found file will be uploaded.'
    required: true
  shotgrid_base_url:
    description: 'The URL of the ShotGrid site you use as a cpenv repo. Store as a github secret.'
    required: true
  shotgrid_script_name:
    description: 'Name of ShotGrid api script. Store as a github secret.'
    required: true
  shotgrid_api_key:
    description: 'ShotGrid api script key. Store as github secret.'
    required: true
  entity_type:
    description: 'Name of ShotGrid entity like, "PipelineConfiguration".'
    required: true
  entity_id:
    description: 'ID of ShotGrid entity.'
    required: true
  field_name:
    description: 'The field of ShotGrid entity to upload to. (eg."uploaded_config")'
    required: true

runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v2
    - name: "Install dependencies"
      # Note: setup-python GitHub action can be tricky to setup on self hosted runners.
      # We skip this action here and setup our dependencies manually.
      run: | 
        python3 -m pip download -r requirements.txt
        unzip shotgun-api3-*.zip
        echo "PYTHONPATH=`pwd`/shotgun-api3" >> $GITHUB_ENV
      shell: bash
    - name: Upload file to ShotGrid
      run: sg_uploader.py --entity_type="${{ inputs.entity_type }}" --entity_id="${{ inputs.entity_id }}" --field_name="${{ inputs.field_name }}" -i="${{ inputs.upload_file }}"
      shell: python
      env:
        SHOTGRID_SITE: "${{ inputs.shotgrid_base_url }}"
        SHOTGRID_SCRIPT_USER: "${{ inputs.shotgrid_script_name }}"
        SHOTGRID_APPLICATION_KEY: "${{ inputs.shotgrid_api_key }}"